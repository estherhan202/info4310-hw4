<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>NFL Suspensions Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 20px;
        background: #f0f0f0;
      }

      #container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }

      h1 {
        text-align: center;
        color: #013369;
        font-size: 24px;
        margin-bottom: 0;
      }

      .grid line {
        stroke: #ccc;
        stroke-opacity: 0.7;
        shape-rendering: crispEdges;
      }

      .subtitle {
        text-align: center;
        font-style: italic;
        color: #4f5155;
        margin-bottom: 15px;
      }

      .control-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-bottom: 20px;
      }

      .control-panel label {
        font-weight: bold;
        margin-right: 5px;
      }

      .control-panel select {
        padding: 5px;
        font-size: 14px;
      }

      .category-title {
        font-style: italic;
        font-size: medium;
      }

      #visualization {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
      }

      .tooltip {
        position: absolute;
        pointer-events: auto;
        background: white;
        border: 1px solid #ccc;
        font-size: 14px;
        padding: 15px;
        width: 320px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 10;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .tooltip-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 16px;
        color: #013369;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }

      .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 16px;
        color: #013369;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }

      .tooltip .close-btn {
        background: none;
        border: none;
        font-size: 18px;
        font-weight: bold;
        color: #d00;
        cursor: pointer;
      }

      .player-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
        transition: background-color 0.3s ease;
      }

      .player-card:hover {
        background-color: #f0f0f0;
      }

      .player-card strong {
        display: block;
        color: #013369;
        font-size: 18px;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 5px;
      }

      .player-card div {
        margin-bottom: 3px;
        line-height: 1.5;
      }

      .player-card em {
        color: #666;
        margin-right: 5px;
      }

      .player-card a {
        color: #1e40af;
        text-decoration: none;
        transition: color 0.3s ease;
        word-break: break-all;
        display: inline-block;
        max-width: 100%;
      }

      .player-card a:hover {
        color: #3b82f6;
        text-decoration: underline;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <h1>NFL Suspensions: Punishment Severity vs. Offense Type</h1>
      <div class="subtitle">
        Analyzing how different violations are penalized across the league
      </div>

      <div class="control-panel" id="filters">
        <div>
          <label for="year-filter">Year Range:</label>
          <select id="year-filter">
            <option value="all">All Years</option>
            <option value="2010-2014">2010-2014</option>
            <option value="2000-2009">2000-2009</option>
            <option value="1990-1999">1990-1999</option>
            <option value="1980-1989">1980-1989</option>
          </select>
        </div>

        <div>
          <label for="length-filter">Suspension Length:</label>
          <select id="length-filter">
            <option value="all">All Lengths</option>
            <option value="short">Short (1-4 games)</option>
            <option value="medium">Medium (5-10 games)</option>
            <option value="long">Long (10+ games)</option>
          </select>
        </div>

        <div>
          <label for="team-filter">Team:</label>
          <select id="team-filter">
            <option value="all">All Teams</option>
          </select>
        </div>
      </div>
      <div id="visualization"></div>
    </div>

    <script>
      const width = 900;
      const height = 350;
      const margin = { top: 60, right: 40, bottom: 140, left: 70 };

      const svg = d3
        .select("#visualization")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      let originalData;

      // Load and process CSV
      d3.csv("NFL Suspensions Data.csv").then((data) => {
        originalData = cleanData(data);
        populateTeamDropdown(originalData);
        updateVis(originalData);
      });

      function cleanData(data) {
        return data
          .map((d) => {
            const games = d.games === "Indef." ? 40 : +d.games;
            let category, subCategory;

            if (d.category.includes("PEDs")) {
              category = "Drug Violations";
              subCategory = d.category.includes("repeated")
                ? "PEDs, more than once"
                : "PEDs";
            } else if (d.category.includes("Substance abuse")) {
              category = "Drug Violations";
              subCategory = d.category.includes("repeated")
                ? "Substance abuse, more than once"
                : "Substance abuse";
            } else if (d.category.includes("In-game violence")) {
              category = "Conduct Violations";
              subCategory = "In-game violence";
            } else if (d.category.includes("Personal conduct")) {
              category = "Conduct Violations";
              subCategory = "Personal conduct";
            } else {
              return null;
            }

            return {
              name: d.name,
              team: d.team,
              games: games,
              year: +d.year,
              description: d.desc,
              category: category,
              subCategory: subCategory,
              source: d.source,
            };
          })
          .filter((d) => d);
      }

      function populateTeamDropdown(data) {
        const teams = Array.from(new Set(data.map((d) => d.team))).sort();
        const teamSelect = d3.select("#team-filter");
        teams.forEach((team) => {
          teamSelect.append("option").attr("value", team).text(team);
        });
      }

      function applyFilters(data) {
        const yearVal = d3.select("#year-filter").property("value");
        const lengthVal = d3.select("#length-filter").property("value");
        const teamVal = d3.select("#team-filter").property("value");

        return data.filter((d) => {
          let pass = true;

          if (yearVal !== "all") {
            const [start, end] = yearVal.split("-").map(Number);
            pass = pass && d.year >= start && d.year <= end;
          }

          if (lengthVal !== "all") {
            if (lengthVal === "short") pass = pass && d.games <= 4;
            if (lengthVal === "medium")
              pass = pass && d.games >= 5 && d.games <= 10;
            if (lengthVal === "long") pass = pass && d.games > 10;
          }

          if (teamVal !== "all") {
            pass = pass && d.team === teamVal;
          }

          return pass;
        });
      }

      function updateVis(data) {
        svg.selectAll("*").remove();

        const filtered = applyFilters(data);
        const subCategoryOrder = [
          "In-game violence",
          "Personal conduct",
          "PEDs",
          "PEDs, more than once",
          "Substance abuse",
          "Substance abuse, more than once",
        ];

        const y = d3
          .scaleBand()
          .domain(
            subCategoryOrder.filter((cat) =>
              filtered.some((d) => d.subCategory === cat)
            )
          )
          .range([0, height])
          .padding(0.3);

        const maxGameInFiltered = d3.max(filtered, (d) => d.games);
        const includeIndef = filtered.some((d) => d.games === 40);
        const yMax = includeIndef ? 40 : Math.ceil(maxGameInFiltered / 10) * 10;
        const x = d3.scaleLog().domain([1, yMax]).range([20, width]); // horizontal range

        svg
          .append("g")
          .attr("transform", `translate(0,${height})`)
          .call(
            d3
              .axisBottom(x)
              .ticks(5)
              .tickFormat((d, i, n) => {
                // Check if it's the maximum value, and replace it with "40+"
                return d === 40 ? "40+" : d;
              })
          );

        const xAxis = d3
          .axisLeft(y)
          .tickValues(d3.range(0, yMax + 1, 5))
          .tickFormat((d) => (d === 40 ? "Indef." : d));

        svg.append("g").call(d3.axisLeft(y));

        // Y-axis label
        svg
          .append("text")
          .attr("x", -height / 2)
          .attr("y", -50)
          .attr("text-anchor", "middle")
          .attr("font-size", "14px")
          .attr("transform", "rotate(-90)")
          .text("Violation Categories");

        // X-axis label
        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", height + 50)
          .attr("text-anchor", "middle")
          .attr("font-size", "14px")
          .text("Number of Games Suspended");

        // Group data by (subCategory, games)
        const groupMap = new Map();
        filtered.forEach((d) => {
          const key = `${d.subCategory}|${d.games}`;
          if (!groupMap.has(key)) groupMap.set(key, []);
          groupMap.get(key).push(d);
        });

        // Find max count per subCategory
        const maxCountsBySubCategory = {};
        groupMap.forEach((group, key) => {
          const [subCategory] = key.split("|");
          if (
            !maxCountsBySubCategory[subCategory] ||
            group.length > maxCountsBySubCategory[subCategory]
          ) {
            maxCountsBySubCategory[subCategory] = group.length;
          }
        });

        // Log scale for circle size
        const sizeScale = d3
          .scaleLog()
          .domain([1, d3.max([...groupMap.values()].map((g) => g.length))])
          .range([5, 20]);

        // Draw circles
        groupMap.forEach((group, key) => {
          const [subCategory, gamesStr] = key.split("|");
          const games = +gamesStr;
          const d = group[0]; // Use first element for category/team info
          const count = group.length;
          const xPos = x(games);
          const yPos = y(subCategory) + y.bandwidth() / 2;

          svg
            .append("circle")
            .attr("cx", xPos)
            .attr("cy", yPos)
            .attr("r", sizeScale(count))
            .attr("fill", "orange")
            .attr("opacity", 0.7)
            .on("mouseover", function (event) {
              d3.select(this)
                .attr("stroke", "#FFB612")
                .attr("stroke-width", 2)
                .attr("fill", "red");
              d3.selectAll(".hover-tooltip").remove();

              const matches = filtered.filter(
                (item) =>
                  item.subCategory === d.subCategory && item.games === d.games
              );

              d3
                .select("body")
                .append("div")
                .attr("class", "tooltip hover-tooltip")
                .style("left", `${event.pageX + 10}px`)
                .style("top", `${event.pageY - 30}px`).html(`
                        <div class="preview-header">${d.subCategory}</div>
                        <div><strong>Games Suspended:</strong> ${
                          d.games === 40 ? "Indefinite" : d.games
                        }</div>
                        <div><strong>Players:</strong> ${matches.length}</div>
                    `);
            })
            .on("mouseout", function () {
              d3.select(this).attr("stroke", null).attr("fill", "orange");
              d3.selectAll(".hover-tooltip").remove();
            })
            .on("click", function (event) {
              showTooltip(event, d, filtered);
            });
        });
      }

      function showTooltip(event, d, data) {
        d3.selectAll(".tooltip").remove();

        const matches = data.filter(
          (item) => item.subCategory === d.subCategory && item.games === d.games
        );

        const tooltip = d3
          .select("body")
          .append("div")
          .attr("class", "tooltip click-tooltip")
          .style("left", `${event.pageX + 10}px`)
          .style("top", `${event.pageY - 30}px`);

        // Header with count
        tooltip.html(`
        <div class="tooltip-header">
          ${d.subCategory} (${d.games === 40 ? "Indef." : d.games} ${
          d.games === 1 ? "game" : "games"
        })

          <button class="close-btn" id="close-tooltip">&times;</button>
        </div>
        <div style="margin-bottom: 10px;"><strong>Total players:</strong> ${
          matches.length
        }</div>
      `);

        // Add player cards
        matches.forEach((item) => {
          console.log(item);
          tooltip.append("div").attr("class", "player-card").html(`
          <strong>${item.name}</strong>
          <div><em>Team:</em> ${item.team}</div>
          <div><em>Year:</em> ${item.year}</div>
          <div><em>Description:</em> ${item.description}</div>
          <div><em>Source:</em> <a href="${item.source}" target="_blank">${item.source}</a></div>
        `);
        });

        // Close button inside the tooltip
        d3.select("#close-tooltip").on("click", () => {
          tooltip.remove();
          document.removeEventListener("click", outsideClickListener);
        });

        // Add outside click listener
        setTimeout(() => {
          document.addEventListener("click", outsideClickListener);
        }, 0);

        function outsideClickListener(event) {
          const isInside = tooltip.node().contains(event.target);
          if (!isInside) {
            tooltip.remove();
            document.removeEventListener("click", outsideClickListener);
          }
        }
      }

      // Event listeners
      d3.selectAll("select").on("change", () => updateVis(originalData));
    </script>
  </body>
</html>
